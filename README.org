#+TITLE: Paperspan2Instaper
#+AUTHOR: Mari Donkers
#+STARTUP: indent
#+OPTIONS: toc:3

* Introduction

Paperspan HTML export to Instapaper CSV import with automatic designation to folders.

Usage: see the [[https://github.com/maridonkers/paperspan2instapaper/blob/master/Makefile][Makefile]].

* Paperspan format
#+BEGIN_SRC html
  <!DOCTYPE html>
  <html>
   <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>PaperSpan Export</title>
   </head>
   <body>
    <h1>Unread</h1>
    <ul>
     <h2>Read Later</h2>
     <ul>
       <li><a href="https://thisisalink" time_added="1630506259000">This is a <i>description</i>.</a></li>
       ...
     </ul>
    </ul>
  ...
    <h1>Read</h1>
   <ul>
    <h2>Read Later</h2>
    <ul>
      <li> ...</li>
      ...
    </ul>
   </ul>
  </body>
#+END_SRC

* Output example
#+BEGIN_SRC haskell
  h <- I.openFile fiPath I.ReadMode
  I.hSetEncoding h I.utf8
  contents <- I.hGetContents h
  let doc = readString [withParseHTML yes, withWarnings no] contents
  links <-
    runX $
      doc
        //> (isElem >>> hasName "body")
          /> (isElem >>> hasName "ul")
          /> ( (isElem >>> hasName "h2")
                 <+> (multi (isElem >>> hasName "a"))
             )
        >>> ( getName
                &&& catA
                  [ getAttrValue "href",
                    getAllText,
                    getAttrValue "time_added"
                  ]
            )
  let putStrLnLink = putStrLnLinkFactory folders conditions
      partitionedLinks = S.chunksOf 3 links -- # should match catA above
  mapM_
    putStrLnLink
    partitionedLinks
#+END_SRC

#+BEGIN_EXAMPLE
URL,Title,Selection,Folder,Timestamp
,"Read Later",,"Paperspan",0000000000000 *** (h2)
https://www.republicain-lorrain.fr/environnement/2021/07/15/inondations-en-nord-moselle-routes-coupees,"Photos. Inondations en Nord Moselle : plusieurs routes coupées",https://www.republicain-lorrain.fr/environnement/2021/07/15/inondations-en-nord-moselle-routes-coupees,"Paperspan",1630506259000 *** (a)
https://www.indiatimes.com/technology/news/solar-storms-internet-shutdown-fear-548309.html,"Massive Solar Storms May Shutdown Internet Around The World, Fears Expert",https://www.indiatimes.com/technology/news/solar-storms-internet-shutdown-fear-548309.html,"Paperspan",1630496044000 *** (a)
https://news360.com/article/563394549,"Stop prescribing hydroxychloroquine for Covid-19, warn researchers | Stop News – India TV",https://news360.com/article/563394549,"Paperspan",1630495255000 *** (a)
https://news360.com/article/563373075,"Increased Viral Load In Lungs Drives Covid-19 Deaths: Study | Nation",https://news360.com/article/563373075,"Paperspan",1630495227000 *** (a)
...
,"Science Technology",,"Paperspan",0000000000000 *** (h2)
https://www.mathjax.org/static-site-generation-for-researchers-an-interview-with-wonseok-shin/,"Static site generation for researchers an interview with Wonseok Shin | MathJax",https://www.mathjax.org/static-site-generation-for-researchers-an-interview-with-wonseok-shin/,"Paperspan",1604325980000 *** (a)
https://www.ligo.org/science/Publication-O3aCatalog/,"The science of LSC research",https://www.ligo.org/science/Publication-O3aCatalog/,"Paperspan",1603999166000 *** (a)
https://phys.org/news/2020-10-discovery-ph-dependent-interaction-pair-protein.html,"Discovery of pH-dependent 'switch' in interaction between pair of protein molecules",https://phys.org/news/2020-10-discovery-ph-dependent-interaction-pair-protein.html,"Paperspan",1603615765000 *** (a)
https://phys.org/news/2020-10-simple-capture-high-quality-d.html,"Researchers develop simple way to capture high quality 3-D images of live cells and organisms",https://phys.org/news/2020-10-simple-capture-high-quality-d.html,"Paperspan",1603488677000 *** (a)
...
#+END_EXAMPLE

* Automatic designation to folders
  
Paperspan HTML export to Instapaper CSV import. With [[https://github.com/maridonkers/paperspan2instapaper/blob/master/folders-example.yaml][folders.yaml]]
configuration file, which contains Instapaper target folder names (for
output file) and [[https://github.com/niklongstone/regular-expression-cheat-sheet][regular expressions]] for =URL= or =text= in Paperspan
export (which is input). Each of the selectors in the configuration file (I have hundreds) is matched against the URL or text of the Paperspan link being umported, until a match is found and an associated folder can be designated to it. This is very useful when you have a lot of undesignated links in your Paperspan (which you did not yet move to a folder).

e.g. the Paperspan link

#+BEGIN_SRC html
      <a href="https://news360.com/article/563394549"
         time_added="1630495255000">
        Stop prescribing hydroxychloroquine for Covid-19, warn researchers | Stop News – India TV
      </a>
#+END_SRC

is matched with the following selector from [[https://github.com/maridonkers/paperspan2instapaper/blob/master/folders-example.yaml][folders.yaml]]:

#+BEGIN_SRC yaml
  - "conditionRegExp": "\\bcovid-19\\b"
    "conditionSource": "text"
    "conditionFolderName": "biologyHealth"
#+END_SRC

which results in designation to the =Biology Health= folder via its folderName (also in [[https://github.com/maridonkers/paperspan2instapaper/blob/master/folders-example.yaml][folders.yaml]]).

#+BEGIN_SRC yaml
  - "folderName": "biologyHealth"
    "folderPath": "Biology Health"
#+END_SRC

and the following CSV line is the result:

#+BEGIN_SRC csv
  https://news360.com/article/563394549,
  "Stop prescribing hydroxychloroquine for Covid-19, warn researchers | Stop News – India TV",
  https://news360.com/article/563394549,
  "Biology Health",
  1630495255000
#+END_SRC

* Blog article

  Is here: [[https://photonsphere.org/posts/2021-10-06-paperspan2instapaper.html][2021-10-06-paperspan2instapaper]].
